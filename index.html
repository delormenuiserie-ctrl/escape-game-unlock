<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Unlock! 5ème Avenue - Mission Talisman</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { 
            background-color: #020617; 
            color: #cbd5e1; 
            margin: 0; 
            overflow-x: hidden; 
            font-family: system-ui, -apple-system, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-10px); } 40%, 80% { transform: translateX(10px); } }
        @keyframes successPulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.5); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        @keyframes archiveFly {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; top: 50%; left: 50%; border-radius: 20px; }
            100% { transform: translate(-50%, -50%) scale(0.05); opacity: 0; top: var(--ty); left: var(--tx); border-radius: 50%; }
        }

        /* Animation des ondes radio */
        @keyframes ripple {
            0% { transform: scale(1); opacity: 0.4; }
            100% { transform: scale(4); opacity: 0; }
        }
        @keyframes orbPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(239, 68, 68, 0.5); }
            50% { transform: scale(1.1); box-shadow: 0 0 40px rgba(239, 68, 68, 0.8); }
        }

        .animate-fade-in { animation: fadeIn 0.6s ease-out forwards; }
        .animate-shake-error { animation: shake 0.4s ease-in-out; border-color: #ef4444 !important; background: rgba(127, 29, 29, 0.4) !important; }
        .animate-success-flash { animation: successPulse 0.4s ease-out; border-color: #10b981 !important; background: rgba(6, 78, 59, 0.4) !important; }
        
        .card-fly-overlay { 
            position: fixed; z-index: 1000; pointer-events: none; 
            width: 200px; aspect-ratio: 2/3; 
            animation: archiveFly 0.85s cubic-bezier(0.4, 0, 0.2, 1) forwards; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }

        .card-ratio { aspect-ratio: 2 / 3; }
        .selected-card { border-color: #eab308 !important; box-shadow: 0 0 25px rgba(234, 179, 8, 0.5); transform: scale(1.02); z-index: 20; }
        .floating-btn { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(12px); border: 1.5px solid rgba(255, 255, 255, 0.2); }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* Éléments de l'effet d'ondes */
        .ripple-container { position: relative; width: 100px; height: 100px; display: flex; align-items: center; justify-content: center; }
        .ripple-circle { position: absolute; border: 2px solid #ef4444; border-radius: 50%; animation: ripple 3s infinite ease-out; width: 100%; height: 100%; }
        .ripple-circle:nth-child(2) { animation-delay: 1s; }
        .ripple-circle:nth-child(3) { animation-delay: 2s; }
        .main-orb { width: 24px; height: 24px; background: #ef4444; border-radius: 50%; z-index: 10; animation: orbPulse 2s infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        /* --- CONFIGURATION --- */
        const GITHUB_AUDIO_PATH = "https://raw.githubusercontent.com/delormenuiserie-ctrl/escape-game-unlock/main/audio/";

        const GAME_DATA = {
            cards: {
                'intro': { id: 'intro', type: 'grey', title: "Mission", desc: "Don Bailat vous charge de dérober le Talisman de Kronos à Don Robinio.", reveals: [5], fallbackImg: "https://raw.githubusercontent.com/delormenuiserie-ctrl/escape-game-unlock/main/carte%20intro%20Don%20bailat.png" },
                5: { id: 5, type: 'grey', title: "Avenue Sombre", desc: "Agent, soyez attentif. Nous devons localiser la sacoche d'équipement.", hint: "La lettre F est cachée dans le décor.", reveals: [], fallbackImg: "https://raw.githubusercontent.com/delormenuiserie-ctrl/escape-game-unlock/main/5eme%20avenu%20carte%205.png" },
                'F': { id: 'F', type: 'grey', title: "Sacoche", desc: "Matériel récupéré.", reveals: [8, 37, 42], fallbackImg: "https://raw.githubusercontent.com/delormenuiserie-ctrl/escape-game-unlock/main/carte%20F%20sacoche.png" },
                44: { id: 44, type: 'blue', title: "Fenêtre Haute", desc: "Une fenêtre restée entrouverte à l'étage.", fallbackImg: "https://raw.githubusercontent.com/delormenuiserie-ctrl/escape-game-unlock/main/44%20carte%20appartement.png" },
                86: { id: 86, type: 'grey', title: "Le Bureau", desc: "Le sanctuaire secret de Robinio.", reveals: [11, 25, 58, 'W'], fallbackImg: "https://raw.githubusercontent.com/delormenuiserie-ctrl/escape-game-unlock/main/carte%2086%20reptembre%20test.png" },
                8: { id: 8, type: 'red', title: "Pied-de-biche", desc: "Pour forcer les caisses.", fallbackImg: "https://raw.githubusercontent.com/delormenuiserie-ctrl/escape-game-unlock/main/carte%208%20pied%20de%20biche.png" },
                15: { id: 15, type: 'red', title: "Épingle", desc: "Fine et résistante.", fallbackImg: "https://raw.githubusercontent.com/delormenuiserie-ctrl/escape-game-unlock/main/carte%2015%20epingle.png" },
                42: { id: 42, type: 'red', title: "Grappin", desc: "Indispensable pour grimper.", fallbackImg: "https://raw.githubusercontent.com/delormenuiserie-ctrl/escape-game-unlock/main/carte%2042%20grappin.png" },
                37: { id: 37, type: 'red', title: "Manette", desc: "Levier de commande électrique.", fallbackImg: "https://raw.githubusercontent.com/delormenuiserie-ctrl/escape-game-unlock/main/carte%2037%20la%20manette.png" },
                11: { id: 11, type: 'grey', title: "Tapis Ancien", desc: "Motif animalier : Aigle et Serpent.", hint: "Aigle (95) vs Serpent (89).", fallbackImg: "https://raw.githubusercontent.com/delormenuiserie-ctrl/escape-game-unlock/main/carte%2011%20tapis.png" },
                58: { id: 58, type: 'blue', title: "Bibliothèque", desc: "Verrouillée par un mécanisme fin.", fallbackImg: "https://raw.githubusercontent.com/delormenuiserie-ctrl/escape-game-unlock/main/carte%2058.png" },
                25: { id: 25, type: 'grey', title: "Portrait", desc: "Don Robinio vous observe.", hint: "Code 43 sur la Machine W.", fallbackImg: "https://raw.githubusercontent.com/delormenuiserie-ctrl/escape-game-unlock/main/carte%2025%20don%20robinio.png" },
                'W': { id: 'W', type: 'green', title: "Machine W", desc: "Sécurité alarme.", hint: "Fils(6) + Manette(37).", fallbackImg: "https://raw.githubusercontent.com/delormenuiserie-ctrl/escape-game-unlock/main/carte%20w%20141.png" },
                'R': { id: 'R', type: 'green', title: "Coffre-fort", desc: "Digicode à 4 chiffres.", fallbackImg: "https://placehold.co/300/450/065f46/FFFFFF?text=Coffre+R" },
                22: { id: 22, type: 'blue', title: "Caisse", desc: "Contient le Talisman !", fallbackImg: "https://placehold.co/300/450/1e40af/FFFFFF?text=Caisse+22" },
                73: { id: 73, type: 'grey', title: "Note Index", desc: "Déchiffrage final.", fallbackImg: "https://placehold.co/300/450/475569/FFFFFF?text=Indice+73" },
                43: { id: 43, type: 'grey', title: "Portrait Ouvert", desc: "Alarme coupée, cachette révélée.", reveals: ['T', 15], fallbackImg: "https://raw.githubusercontent.com/delormenuiserie-ctrl/escape-game-unlock/main/carte%2043.png" },
                'T': { id: 'T', type: 'gold', title: "Talisman", desc: "L'artefact de Kronos.", fallbackImg: "https://placehold.co/300/450/f59e0b/FFFFFF?text=TALISMAN" },
                30: { id: 30, type: 'gold', title: "Victoire", desc: "Mission réussie !", fallbackImg: "https://placehold.co/300/450/854d0e/FFFFFF?text=VICTOIRE" }
            },
            combinations: { "15+58": 73, "37+W": 43, "8+22": 30, "42+44": 86 },
            codes: { 'W': "43", 'R': "9589" }
        };

        const AUTO_DISCARD = { 5: ['intro'], 86: [5, 44, 42, 'F'], 73: [15, 58], 43: [37, 'W', 25], 30: [8, 22] };
        const ALL_IDS = ['intro', 5, 8, 11, 15, 22, 25, 30, 37, 42, 58, 73, 86, 'W', 'F', 'R', 'T'];

        /* --- COMPOSANTS INTERNES --- */
        const IconPuzzleMale = () => (
          <svg width="24" height="24" viewBox="0 0 24 24"><rect x="4" y="4" width="12" height="16" rx="1" fill="#f87171" /><circle cx="16" cy="12" r="3.5" fill="#f87171" /></svg>
        );
        const IconPuzzleFemale = () => (
          <svg width="24" height="24" viewBox="0 0 24 24"><rect x="8" y="4" width="12" height="16" rx="1" fill="#60a5fa" /><circle cx="8" cy="12" r="3.5" fill="#020617" /></svg>
        );

        function App() {
            const [view, setView] = useState('home');
            const [hand, setHand] = useState([]);
            const [discardPile, setDiscardPile] = useState([]);
            const [foundIds, setFoundIds] = useState(new Set());
            const [time, setTime] = useState(0);
            const [penalty, setPenalty] = useState(0);
            const [selectedId, setSelectedId] = useState(null);
            const [inputValue, setInputValue] = useState("");
            const [zoomedCard, setZoomedCard] = useState(null);
            const [showZoomInfo, setShowZoomInfo] = useState(false);
            const [activeMachine, setActiveMachine] = useState(null);
            const [machineCode, setMachineCode] = useState("");
            const [showArchive, setShowArchive] = useState(false);
            const [inspectCard, setInspectCard] = useState(null);
            const [animatingCards, setAnimatingCards] = useState([]);
            const [codeState, setCodeState] = useState(null);
            const [isMuted, setIsMuted] = useState(false);
            const [isInitialLoaded, setIsInitialLoaded] = useState(false);

            const audioCtxRef = useRef(null);
            const masterGainRef = useRef(null);
            const gridBtnRef = useRef(null);
            const currentNarrativeRef = useRef(null);

            /* --- PRECHARGEMENT HYBRIDE --- */
            useEffect(() => {
                const priority = ['intro', 5, 'F'];
                let loadedCount = 0;
                priority.forEach(id => {
                    const img = new Image();
                    img.src = GAME_DATA.cards[id].fallbackImg;
                    img.onload = () => {
                        loadedCount++;
                        if(loadedCount === priority.length) {
                            setTimeout(() => setIsInitialLoaded(true), 2000);
                        }
                    };
                });
                Object.values(GAME_DATA.cards).forEach(c => {
                    if(!priority.includes(c.id)) {
                        const img = new Image();
                        img.src = c.fallbackImg;
                    }
                });
            }, []);

            useEffect(() => {
                if (view === 'game') {
                    addCard('intro', true);
                    const timer = setInterval(() => setTime(prev => prev + 1), 1000);
                    return () => clearInterval(timer);
                }
            }, [view]);

            /* --- MOTEUR AUDIO (AMBANCE + PIANO) --- */
            const initAudio = () => {
                if (!audioCtxRef.current) {
                    audioCtxRef.current = new (window.AudioContext || window.webkitAudioContext)();
                    masterGainRef.current = audioCtxRef.current.createGain();
                    masterGainRef.current.connect(audioCtxRef.current.destination);
                    startAmbience();
                }
                if (audioCtxRef.current.state === 'suspended') audioCtxRef.current.resume();
            };

            const startAmbience = () => {
                const now = audioCtxRef.current.currentTime;
                
                // 1. Drone sourd permanent
                const createDrone = (freq, vol) => {
                    const osc = audioCtxRef.current.createOscillator();
                    const g = audioCtxRef.current.createGain();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq, now);
                    g.gain.setValueAtTime(0, now);
                    g.gain.linearRampToValueAtTime(vol, now + 4);
                    osc.connect(g); g.connect(masterGainRef.current);
                    osc.start();
                };
                createDrone(55, 0.04); createDrone(65.4, 0.03);

                // 2. Piano Mélancolique (Volume amplifié à 0.12)
                const minorScale = [110.00, 130.81, 146.83, 164.81, 174.61]; 
                const playNoirPiano = () => {
                    if (view !== 'game') return;
                    const osc = audioCtxRef.current.createOscillator();
                    const g = audioCtxRef.current.createGain();
                    const note = minorScale[Math.floor(Math.random()*minorScale.length)];
                    
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(note, audioCtxRef.current.currentTime);
                    g.gain.setValueAtTime(0, audioCtxRef.current.currentTime);
                    g.gain.linearRampToValueAtTime(0.12, audioCtxRef.current.currentTime + 1);
                    g.gain.exponentialRampToValueAtTime(0.001, audioCtxRef.current.currentTime + 10);
                    
                    osc.connect(g); g.connect(masterGainRef.current);
                    osc.start(); osc.stop(audioCtxRef.current.currentTime + 10);
                    
                    setTimeout(playNoirPiano, 5000 + Math.random()*4000);
                };
                playNoirPiano();

                // 3. Craquement Vinyle
                const crackle = () => {
                    const osc = audioCtxRef.current.createOscillator();
                    const g = audioCtxRef.current.createGain();
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(Math.random() * 5000 + 500, audioCtxRef.current.currentTime);
                    g.gain.setValueAtTime(Math.random() * 0.007, audioCtxRef.current.currentTime);
                    g.gain.exponentialRampToValueAtTime(0.0001, audioCtxRef.current.currentTime + 0.004);
                    osc.connect(g); g.connect(masterGainRef.current);
                    osc.start(); osc.stop(audioCtxRef.current.currentTime + 0.004);
                    setTimeout(crackle, Math.random() * 2000 + 400);
                };
                crackle();
            };

            const playOrganicSound = (type) => {
                if (isMuted || !audioCtxRef.current) return;
                const now = audioCtxRef.current.currentTime;
                const gain = audioCtxRef.current.createGain();
                if (type === 'archive') {
                    const noise = audioCtxRef.current.createBufferSource();
                    const buffer = audioCtxRef.current.createBuffer(1, audioCtxRef.current.sampleRate * 0.4, audioCtxRef.current.sampleRate);
                    const data = buffer.getChannelData(0);
                    for(let i=0; i<buffer.length; i++) data[i] = Math.random() * 2 - 1;
                    noise.buffer = buffer;
                    const filter = audioCtxRef.current.createBiquadFilter();
                    filter.type = 'lowpass'; filter.frequency.setValueAtTime(800, now);
                    gain.gain.setValueAtTime(0.08, now); gain.gain.linearRampToValueAtTime(0, now + 0.4);
                    noise.connect(filter); filter.connect(gain); gain.connect(masterGainRef.current);
                    noise.start();
                } else if (type === 'click') {
                    const osc = audioCtxRef.current.createOscillator();
                    osc.type = 'square'; osc.frequency.setValueAtTime(140, now);
                    gain.gain.setValueAtTime(0.02, now); gain.gain.linearRampToValueAtTime(0, now + 0.05);
                    osc.connect(gain); gain.connect(masterGainRef.current);
                    osc.start(); osc.stop(now + 0.05);
                } else if (type === 'success') {
                    const osc = audioCtxRef.current.createOscillator();
                    osc.type = 'sine'; osc.frequency.setValueAtTime(200, now);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 1.2);
                    osc.connect(gain); gain.connect(masterGainRef.current);
                    osc.start(); osc.stop(now + 1.2);
                } else if (type === 'error') {
                    const osc = audioCtxRef.current.createOscillator();
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(50, now);
                    gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.connect(gain); gain.connect(masterGainRef.current);
                    osc.start(); osc.stop(now + 0.3);
                }
            };

            const playNarrative = (id, type = 'desc') => {
                if (isMuted) return;
                
                // Sécurité : Stopper l'audio précédent avant d'en lancer un nouveau
                if (currentNarrativeRef.current) {
                    currentNarrativeRef.current.pause();
                    currentNarrativeRef.current.currentTime = 0;
                }

                const audio = new Audio(`${GITHUB_AUDIO_PATH}${type}_${id}.wav`);
                audio.volume = 0.15; // Murmure
                currentNarrativeRef.current = audio;
                audio.play().catch(() => console.log(`Fichier ${type}_${id}.wav manquant.`));
            };

            /* --- LOGIQUE JEU --- */
            const addCard = (id, silent = false) => {
                const card = GAME_DATA.cards[id];
                if (!card || hand.some(c => String(c.id) === String(id)) || discardPile.some(c => String(c.id) === String(id))) return;
                setFoundIds(p => new Set(p).add(id));
                let currentHand = [...hand, card];
                let toArchive = [];
                if (AUTO_DISCARD[id]) {
                    toArchive = currentHand.filter(c => AUTO_DISCARD[id].some(did => String(did) === String(c.id)));
                    currentHand = currentHand.filter(c => !AUTO_DISCARD[id].some(did => String(did) === String(c.id)));
                }
                setHand(currentHand);
                if(!silent) { playOrganicSound('click'); playNarrative(id, 'reveal'); }
                if (toArchive.length > 0) toArchive.forEach((c, i) => setTimeout(() => executeArchiveFly(c), i * 200));
            };

            const executeArchiveFly = (card) => {
                if (!gridBtnRef.current) return;
                const rect = gridBtnRef.current.getBoundingClientRect();
                const animId = Math.random().toString(36);
                setAnimatingCards(p => [...p, { ...card, animId, tx: rect.left + rect.width/2, ty: rect.top + rect.height/2 }]);
                playOrganicSound('archive');
                setTimeout(() => {
                    setAnimatingCards(p => p.filter(c => c.animId !== animId));
                    setDiscardPile(p => [...p, card]);
                }, 850);
            };

            const handleCodeSubmit = (e) => {
                e.preventDefault();
                const v = inputValue.toUpperCase();
                let tid = GAME_DATA.cards[v] ? v : (v === 'F' ? 'F' : (v === 'R' ? 'R' : null));
                if (tid && !foundIds.has(tid)) {
                    addCard(tid);
                    setCodeState('success'); setTimeout(()=>setCodeState(null), 600);
                } else {
                    playOrganicSound('error'); setPenalty(p => p + 2); setCodeState('error'); setTimeout(()=>setCodeState(null), 600);
                }
                setInputValue("");
            };

            const combine = (id1, id2) => {
                const key = [id1, id2].sort((a,b) => String(a).localeCompare(String(b))).join('+');
                const res = GAME_DATA.combinations[key];
                if (res) {
                    playOrganicSound('success');
                    const c1 = hand.find(c => String(c.id) === String(id1));
                    const c2 = hand.find(c => String(c.id) === String(id2));
                    setHand(p => p.filter(c => String(c.id) !== String(id1) && String(c.id) !== String(id2)));
                    if (c1) executeArchiveFly(c1); if (c2) setTimeout(() => executeArchiveFly(c2), 200);
                    addCard(res);
                } else { playOrganicSound('error'); setPenalty(p => p + 1); }
                setSelectedId(null);
            };

            const solveMachine = (m, code) => {
                if (code === GAME_DATA.codes[m.id]) {
                    playOrganicSound('success');
                    if (m.id === 'W') {
                        setHand(p => p.map(c => c.id === 'W' ? { ...c, type: 'blue', title: "Sécurité OFF" } : c));
                        setActiveMachine(null); addCard(43);
                    } else {
                        const mc = hand.find(c => String(c.id) === String(m.id));
                        setHand(p => p.filter(c => String(c.id) !== String(m.id)));
                        if (mc) executeArchiveFly(mc);
                        if (m.id === 'R') addCard(22);
                        setActiveMachine(null);
                    }
                } else { playOrganicSound('error'); setPenalty(p => p + 3); }
                setMachineCode("");
            };

            if (view === 'home') return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-[#020617] p-8 text-center animate-fade-in">
                    <div className="ripple-container mb-12">
                        <div className="ripple-circle"></div>
                        <div className="ripple-circle"></div>
                        <div className="ripple-circle"></div>
                        <div className="main-orb"></div>
                    </div>
                    
                    <h1 className="text-3xl font-black text-white uppercase tracking-[0.4em] mb-4">Liaison Orus</h1>
                    
                    {!isInitialLoaded ? (
                        <div className="space-y-4 py-8">
                            <p className="text-[10px] text-red-500 font-black uppercase animate-pulse">Synchronisation du signal...</p>
                        </div>
                    ) : (
                        <div className="space-y-8 animate-fade-in">
                            <div className="max-w-xs mx-auto space-y-4">
                                <p className="text-xs text-slate-500 font-bold uppercase tracking-widest text-blue-400">Protocole de Connexion</p>
                                <div className="text-[11px] text-slate-400 leading-relaxed bg-black/40 p-5 rounded-2xl border border-slate-800 text-left border-l-4 border-l-red-600 shadow-2xl">
                                    "Agent, le canal est sécurisé. Votre infiltration sur la 5ème Avenue commence maintenant. Ne faites aucune erreur, le Don n'aime pas attendre."
                                </div>
                            </div>
                            <button onClick={() => { initAudio(); setView('game'); }} className="py-6 px-14 bg-red-700 hover:bg-red-600 text-white font-black rounded-full uppercase tracking-widest active:scale-95 shadow-[0_0_30px_rgba(185,28,28,0.4)] transition-all">Se Connecter</button>
                        </div>
                    )}
                </div>
            );

            return (
                <div className="flex flex-col items-center min-h-screen w-full bg-[#020617] text-slate-300 overflow-hidden font-sans">
                    {animatingCards.map(c => (
                        <div key={c.animId} className="card-fly-overlay overflow-hidden border-2 border-white/20 shadow-2xl bg-slate-900" style={{'--tx': `${c.tx}px`, '--ty': `${c.ty}px`}}>
                            <img src={c.fallbackImg} className="w-full h-full object-cover" />
                        </div>
                    ))}

                    {/* Header */}
                    <div className="w-full max-w-lg bg-slate-900/95 backdrop-blur-md p-2 rounded-2xl border border-slate-700 flex items-center gap-2 sticky top-2 z-50 mb-6 mx-2 shadow-2xl">
                        <div className="flex flex-col items-center bg-black/40 px-3 py-1.5 rounded-xl border border-slate-800 min-w-[80px]">
                            <div className="font-mono font-bold text-white text-sm">{Math.floor(time/60)}:{(time%60).toString().padStart(2,'0')}</div>
                            {penalty > 0 && <span className="text-[9px] text-red-500 font-black">+{penalty}m</span>}
                        </div>
                        <form onSubmit={handleCodeSubmit} className={`flex-grow flex items-center bg-black/50 border border-slate-700 rounded-xl px-2 transition-all ${codeState === 'error' ? 'animate-shake-error' : codeState === 'success' ? 'animate-success-flash' : ''}`}>
                            <input value={inputValue} onChange={e => setInputValue(e.target.value)} placeholder="CODE" className="w-full bg-transparent p-2 text-white font-black text-center text-sm outline-none uppercase tracking-widest" />
                            <button className="p-2 text-blue-500 font-black">OK</button>
                        </form>
                        <button ref={gridBtnRef} onClick={() => setShowArchive(true)} className="p-2.5 bg-slate-800 rounded-xl active:scale-95 text-slate-400">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                        </button>
                    </div>

                    {/* Grille de jeu */}
                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-4 w-full max-w-lg px-3 pb-32 overflow-y-auto no-scrollbar">
                        {hand.map(c => (
                            <div key={c.id} className={`group relative card-ratio bg-slate-900 border-2 rounded-[1.8rem] overflow-hidden transition-all ${selectedId === c.id ? 'selected-card' : 'border-slate-800'}`}>
                                <div className="w-full h-full cursor-pointer relative" onClick={() => { setZoomedCard(c); setShowZoomInfo(false); }}>
                                    <img src={c.fallbackImg} className="w-full h-full object-cover" />
                                    <div className="absolute top-0 right-0 bg-black/80 px-4 py-1.5 font-black text-white rounded-bl-2xl text-xs">{c.id}</div>
                                    <div className="absolute bottom-3 left-0 right-0 flex justify-end px-3">
                                        {(c.type === 'red' || c.type === 'blue' || c.type === 'green') && (
                                            <button onClick={(e) => { e.stopPropagation(); if (c.type === 'green') setActiveMachine(c); else if (selectedId === null) setSelectedId(c.id); else if (selectedId === c.id) setSelectedId(null); else combine(selectedId, c.id); }} className={`w-12 h-12 bg-slate-900/80 backdrop-blur-md border border-white/20 rounded-full flex items-center justify-center shadow-xl active:scale-90 ${selectedId === c.id ? 'bg-yellow-500' : ''}`}>
                                                {c.type === 'green' ? '⚙' : (c.type === 'red' ? <IconPuzzleMale /> : <IconPuzzleFemale />)}
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Zoom Immersif */}
                    {zoomedCard && (
                        <div className="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center animate-fade-in" onClick={() => setShowZoomInfo(!showZoomInfo)}>
                            <img src={zoomedCard.fallbackImg} className="max-h-[100vh] max-w-full object-contain" />
                            <button onClick={(e) => { e.stopPropagation(); setZoomedCard(null); }} className="absolute top-8 right-8 bg-black/60 p-5 rounded-full text-white border border-white/20 active:scale-90 shadow-2xl"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                            <div className={`absolute bottom-0 left-0 right-0 bg-slate-950/90 p-8 rounded-t-[3rem] transition-transform duration-300 ${showZoomInfo ? 'translate-y-0' : 'translate-y-full'}`} onClick={e => e.stopPropagation()}>
                                <h2 className="text-2xl font-black mb-4 uppercase text-white border-b border-slate-800 pb-4 tracking-tighter">{zoomedCard.title}</h2>
                                <p className="text-slate-400 text-base mb-8 italic">"{zoomedCard.desc}"</p>
                                <div className="flex flex-col gap-3">
                                    {/* Correction : Le zoom reste actif quand on prend une carte révélée */}
                                    {zoomedCard.reveals?.filter(id => !foundIds.has(id)).map(id => (
                                        <button key={id} onClick={() => { addCard(id); }} className="w-full py-5 rounded-2xl font-black bg-blue-600 text-white uppercase text-sm tracking-widest shadow-xl">Prendre carte {id}</button>
                                    ))}
                                    <button onClick={() => setShowZoomInfo(false)} className="w-full py-4 text-slate-500 font-bold uppercase text-[10px] tracking-widest">Refermer</button>
                                </div>
                            </div>
                            {!showZoomInfo && <button onClick={(e) => { e.stopPropagation(); setShowZoomInfo(true); playNarrative(zoomedCard.id, 'desc'); }} className="absolute bottom-20 bg-slate-900/90 px-8 py-5 rounded-full border border-slate-700 text-xs font-black uppercase text-white flex items-center gap-3 active:scale-95 shadow-2xl"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Analyser</button>}
                        </div>
                    )}

                    {/* Archives */}
                    {showArchive && (
                        <div className="fixed inset-0 z-[250] bg-slate-950 flex flex-col animate-fade-in">
                            <div className="bg-slate-900 p-6 flex justify-between items-center border-b border-slate-800">
                                <h3 className="text-white font-black uppercase tracking-widest text-sm text-center w-full">Dossier de Mission</h3>
                                <button onClick={() => setShowArchive(false)} className="p-2 text-slate-400 absolute right-4 active:scale-95"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                            </div>
                            <div className="flex-grow overflow-y-auto p-4 no-scrollbar">
                                <div className="grid grid-cols-3 gap-3">
                                    {ALL_IDS.map(id => {
                                        const isFound = foundIds.has(id), card = GAME_DATA.cards[id];
                                        return (
                                            <div key={id} onClick={() => isFound ? setInspectCard(card) : null} className={`aspect-[2/3] rounded-xl border-2 flex items-center justify-center relative overflow-hidden active:scale-95 ${isFound ? 'border-blue-500/50 bg-slate-900 shadow-lg' : 'border-slate-800 bg-black/20'}`}>
                                                {isFound ? (
                                                    <>
                                                        <img src={card.fallbackImg} className="absolute inset-0 w-full h-full object-cover opacity-60 grayscale-[50%]" />
                                                        <span className="font-black z-10 text-white text-base bg-black/40 px-2 rounded-lg">{id === 'intro' ? 'I' : id}</span>
                                                    </>
                                                ) : <span className="text-slate-800 font-black text-3xl">?</span>}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {inspectCard && (
                        <div className="fixed inset-0 z-[300] bg-black/95 flex items-center justify-center p-4 animate-fade-in" onClick={() => setInspectCard(null)}>
                            <div className="bg-slate-900 rounded-[2.5rem] w-full max-w-sm overflow-hidden border border-slate-700 shadow-2xl" onClick={e => e.stopPropagation()}>
                                <img src={inspectCard.fallbackImg} className="w-full aspect-[3/2] object-cover" />
                                <div className="p-8">
                                    <h2 className="text-2xl font-black text-white uppercase mb-4 tracking-tighter">{inspectCard.title}</h2>
                                    <p className="text-slate-400 text-sm italic mb-8">"{inspectCard.desc}"</p>
                                    <button onClick={() => setInspectCard(null)} className="w-full py-4 bg-slate-800 text-white font-black uppercase text-xs rounded-2xl active:scale-95">Refermer</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Machine Modal */}
                    {activeMachine && (
                        <div className="fixed inset-0 z-[150] bg-black/90 flex items-center justify-center p-4">
                            <div className="bg-slate-900 border-2 border-emerald-500 p-8 rounded-[3rem] max-w-xs w-full shadow-2xl">
                                <h3 className="text-emerald-400 font-black mb-6 uppercase text-center tracking-widest">{activeMachine.title}</h3>
                                <input autoFocus value={machineCode} onChange={e => setMachineCode(e.target.value.replace(/\D/g,'').slice(0,4))} onKeyDown={e => e.key === 'Enter' && solveMachine(activeMachine, machineCode)} placeholder="----" className="w-full bg-black/60 border border-slate-800 rounded-2xl p-8 mb-10 text-center text-6xl font-mono text-emerald-500 outline-none tracking-[10px]" />
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={() => setActiveMachine(null)} className="py-5 bg-slate-800 rounded-2xl font-bold text-slate-500 uppercase text-[10px]">Annuler</button>
                                    <button onClick={() => solveMachine(activeMachine, machineCode)} className="py-5 bg-emerald-600 text-black rounded-2xl font-black shadow-lg uppercase text-[10px]">Valider</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
